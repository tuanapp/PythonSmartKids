@startuml FlowD_HighLevel
title Unified Performance Report + Q&A Workflow

skinparam backgroundColor #FFFFFF
skinparam ActivityDiamondBackgroundColor #F1F1F1
skinparam ActivityBackgroundColor #FEFECE
skinparam NoteBackgroundColor #E1F5FE

|User/System|
start
:User request with query_text;

|IntentRouterAgent|
:Classify intent: "report" vs "qa";
:Extract subject/topic from query;
note right
  **Heuristics:**
  - QA: "what", "which", "most often"
  - Report: "generate report", "full"
  - Default: QA
end note

|Guardrails|
:InputGuardrails: Mask PII, check injection;
if (Blocked by guardrails?) then (yes)
  :Return blocked response;
  stop
endif

|Workflow Orchestrator|
if (Intent == "report") then (yes)
  :CooldownChecker: Check 24h limit;
  
  if (Cooldown active?) then (yes)
    :Return cooldown response;
    stop
  endif
  
  |DataIngesterAgent|
  :extract_data (Postgres);
  :import_to_neo4j_with_embeddings;
  note right
    - Wipe Neo4j
    - Generate Embeddings
    - Create Vector Index
  end note

  |RetrieverAgent|
  repeat
    :retrieve_graph_context;
    :retrieve_vector_context;
    :retrieve_hybrid_context;
    :assess_evidence_quality;
  repeat while (Evidence sufficient OR max retries?) is (no)
  
  |AnalystAgent|
  :generate_report (Gemini AI);
  :Save to performance_reports;

else (no: Q&A Path)
  |System/Database|
  :Build fallback context (SQL);
  note right: Extracts most missed questions

  |RetrieverAgent|
  repeat
    :retrieve_graph_context (Filtered);
    :retrieve_vector_context (Scoped);
    :retrieve_hybrid_context;
    :assess_evidence_quality;
  repeat while (Evidence sufficient OR max retries?) is (no)

  |AnalystAgent|
  :generate_answer (Gemini AI);
  
  |Guardrails|
  :OutputGuardrails Check;
  
  |System/Database|
  if (No AI answer?) then (yes)
    :Use database fallback answer;
  endif
  :Save to performance_reports;
endif

|User/System|
:Return response;
stop

footer
  **Response Includes:** agents_executed, execution_path, response_source, quality_scores, is_fallback
end footer
@enduml

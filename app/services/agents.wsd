@startuml FlowD_HighLevel
title Unified Performance Report + Q&A Workflow

skinparam backgroundColor #FFFFFF
skinparam ActivityDiamondBackgroundColor #F1F1F1
skinparam ActivityBackgroundColor #FEFECE
skinparam NoteBackgroundColor #E1F5FE

|User/System|
start
:User request with query_text;

|IntentRouterAgent|
:Classify intent: "report" vs "qa";
:Extract subject/topic from query;
note right
  **Heuristics:**
  - QA: "what", "which", "most often"
  - Report: "generate report", "full"
  - Default: QA
  - Optional LLM classification when available
end note

|Guardrails|
:InputGuardrails: Mask PII, check injection/disallowed content;
if (Blocked by guardrails?) then (yes)
  :Return blocked response;
  stop
endif

|Workflow Orchestrator|
if (Intent == "report") then (yes)
  :CooldownChecker: Check 24h limit;
  note right
    Cooldown bypass:
    - If admin_key matches env ADMIN_KEY
  end note
  
  if (Cooldown active?) then (yes)
    :Return cooldown response;
    stop
  endif
  
  if (admin_key = "skip_data_ingester"?) then (yes)
    :Reuse existing Neo4j data;
  else (no)
    |DataIngesterAgent|
    :extract_data (Postgres);
    :import_to_neo4j_with_embeddings;
    note right
      - Wipe Neo4j
      - Hierarchical categorization
      - Generate Embeddings
      - Create Vector Index
    end note
  endif

  |RetrieverAgent|
  repeat
    :retrieve_graph_context;
    :retrieve_vector_context;
    :retrieve_hybrid_context;
    :assess_evidence_quality;
  repeat while (Evidence sufficient OR max retries?) is (no)
  note right
    - Graph includes Topic/SubTopic/Concept breakdown
    - Hybrid merges vector context + fallback
  end note
  
  |AnalystAgent|
  :generate_report (Gemini AI);
  :Save to performance_reports;
  note right: Optional LangSmith tracing

else (no: Q&A Path)
  |System/Database|
  :Build fallback context (SQL);
  note right: Extracts most missed questions

  :Skip ingestion (default) and reuse existing Neo4j data;
  |RetrieverAgent|
  repeat
    :retrieve_graph_context (Filtered);
    :retrieve_vector_context (Scoped);
    :retrieve_hybrid_context;
    :assess_evidence_quality;
  repeat while (Evidence sufficient OR max retries?) is (no)
  note right
    - Graph includes Topic/SubTopic/Concept breakdown
    - Hybrid merges vector context + fallback
  end note

  |AnalystAgent|
  :generate_answer (Gemini AI);
  
  |Guardrails|
  :OutputGuardrails Check;
  
  |System/Database|
  if (Empty/insufficient AI answer?) then (yes)
    :Use database fallback answer;
  endif
  :Save to performance_reports;
endif

|User/System|
:Return response;
stop

footer
  **Response Includes:** agents_executed, execution_path, response_source, evidence_quality_score, is_fallback, guardrails, trace_id
end footer
@enduml

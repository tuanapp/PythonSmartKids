@startuml FlowD_HighLevel
title Unified Performance Report + Q&A Workflow (Actual Implementation)
skinparam backgroundColor #FFFFFF

start
:User request with query_text;
:**IntentRouterAgent**\nClassify intent: "report" vs "qa"\nExtract subject/topic from query;
note right
  Uses heuristics:
  - QA indicators: "what", "which", "type of", "most often"
  - Report indicators: "generate report", "full report"
  - Subject/topic detection â†’ QA
  - Default: QA
end note

:**InputGuardrails**\nMask PII, check prompt injection,\ncheck disallowed content;

if (Blocked by guardrails?) then (yes)
  :Return blocked response\nwith agents_executed,\nexecution_path, response_source;
  stop
endif

if (Intent == "report") then (yes)
  :**CooldownChecker**\nCheck 24h cooldown from\nperformance_reports table;
  
  if (Cooldown active?) then (yes)
    :Return cooldown response\nagents_executed: ["CooldownChecker"]\nexecution_path: "cooldown_blocked"\nresponse_source: "cooldown_limit";
    stop
  endif
  
  :Initialize LangGraph workflow\n(or simplified workflow);
  
  :***DataIngesterAgent***\n**extract_data**: Load from PostgreSQL\n- users, subjects, knowledge_question_attempts;
  
  :***DataIngesterAgent***\n**import_to_neo4j_with_embeddings**:\n- Wipe Neo4j database\n- Import students, subjects\n- Generate embeddings for attempts\n- Create vector index;
  
  partition "Retrieval Loop (max 3 attempts)" {
    :***RetrieverAgent***\n**retrieve_graph_context**:\nCypher query for subject performance;
    
    :***RetrieverAgent***\n**retrieve_vector_context**:\nVector similarity search (top 5);
    
    :***RetrieverAgent***\n**retrieve_hybrid_context**:\nCombine graph + vector context;
    
    :***RetrieverAgent***\n**assess_evidence_quality**:\nCalculate score (0-1);
    
    if (Evidence sufficient\nOR max retries?) then (yes)
      :Exit retrieval loop;
    else (no)
      :Retry retrieval with\nadjusted query;
      backward:Retry;
    endif
  }
  
  :***AnalystAgent***\n**generate_report**:\nGemini AI generates comprehensive\nmarkdown report;
  
  :Save to performance_reports table\n(report_content, execution_log, etc.);
  
  :Return response\nagents_executed: ["CooldownChecker",\n"DataIngester", "Retriever", "Analyst"]\nexecution_path: "report_workflow"\nresponse_source: "ai_generated";
  
else (Q&A)
  :Extract subject/topic from query\n(if not already extracted);
  
  :Build fallback context\nfrom knowledge_question_attempts\n(database query with keywords);
  note right
    Extracts most missed questions
    to supplement AI context
  end note
  
  :Initialize agents:\n- DataIngesterAgent\n- RetrieverAgent\n- AnalystAgent;
  
  partition "Retrieval Loop (max 3 attempts)" {
    :***RetrieverAgent***\n**retrieve_graph_context**:\nCypher with subject/topic filter;
    
    :***RetrieverAgent***\n**retrieve_vector_context**:\nVector search with query embedding\n+ subject/topic filter;
    
    :***RetrieverAgent***\n**retrieve_hybrid_context**:\nCombine graph + vector + fallback;
    
    :***RetrieverAgent***\n**assess_evidence_quality**:\nCalculate score (0-1);
    
    if (Evidence sufficient\nOR max retries?) then (yes)
      :Exit retrieval loop;
    else (no)
      :Retry retrieval;
      backward:Retry;
    endif
  }
  
  :***AnalystAgent***\n**generate_answer**:\nGemini AI generates focused answer\nfor specific subject/topic;
  
  :**OutputGuardrails**\nCheck for disallowed content;
  
  if (No AI answer?) then (yes)
    :Use database fallback answer\n(most missed questions);
  endif
  
  :Save to performance_reports table\n(report_format: "qa");
  
  :Return response\nagents_executed: ["IntentRouter",\n"InputGuardrails", "DataIngester",\n"Retriever", "Analyst", "OutputGuardrails"]\nexecution_path: "qa_workflow"\nis_fallback: true/false\nresponse_source: "ai_generated"\n/"database_fallback"/"database_only";
endif

stop

note bottom
  **Response Fields (All Paths):**
  - success, student_uid, intent
  - subject, topic, query
  - answer (QA) / analysis_report (Report)
  - agents_executed (ordered list)
  - execution_path (workflow identifier)
  - is_fallback (database-only flag)
  - response_source (origin indicator)
  - evidence_sufficient, evidence_quality_score
  - retrieval_attempts, processing_time_ms
  - model_used, guardrails, timestamp
end note

@enduml
